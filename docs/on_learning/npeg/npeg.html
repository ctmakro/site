<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <script>
      (function() {
      var method;
      var methods = [
          'assert', 'clear', 'count', 'debug', 'dir', 'dirxml', 'error',
          'exception', 'group', 'groupCollapsed', 'groupEnd', 'info', 'log',
          'markTimeline', 'profile', 'profileEnd', 'table', 'time', 'timeEnd',
          'timeline', 'timelineEnd', 'timeStamp', 'trace', 'warn'
      ];
      var length = methods.length;
      var console = (window.console = window.console || {});
      while (length--) {
          method = methods[length];
          // Only stub undefined methods.
          if (!console[method]) {
              console[method] = function () {};
          }
      }
      }());
      
      
    </script>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="./../../basic.css" rel="stylesheet" type="text/css">
    <link rel="shortcut icon" href="./../../favicon.ico">
    <title>NPEG图像压缩</title>
  </head>
  <body id="body">
    <div class="navigation_area">
      <div class="navnode">
              <div class="navnode_title">/</div>
              <div class="navnode"><a href="./../../index.html">Index</a>
              </div>
              <div class="navnode"><a href="./../../bio.html">About</a>
              </div>
              <div class="navnode">
                      <div class="navnode_title">/lit</div>
                      <div class="navnode"><a href="./../../lit/why_bad_idea.html">Why Smart People Have Bad Ideas</a>
                      </div>
              </div>
              <div class="navnode">
                      <div class="navnode_title">/on_learning</div>
                      <div class="navnode"><a href="./../../on_learning/tf1c.html"> Compiling TensorFlow</a>
                      </div>
                      <div class="navnode"><a href="./../../on_learning/course_resources.html">Learning Resources</a>
                      </div>
                      <div class="navnode"><a href="./../../on_learning/fast_gan_in_keras.html"> Fast DCGAN in Keras</a>
                      </div>
                      <div class="navnode"><a href="./../../on_learning/gan.html">GAN 生成式对抗网络</a>
                      </div>
                      <div class="navnode"><a href="./../../on_learning/gd.html">Gradient Descent 梯度下降法</a>
                      </div>
                      <div class="navnode"><a href="./../../on_learning/artist.html">Training of Artists</a>
                      </div>
                      <div class="navnode"><a href="./../../on_learning/how_to.html">Baby steps for ML</a>
                      </div>
                      <div class="navnode"><a href="./../../on_learning/resnet_keras.html">Residual Network in Keras</a>
                      </div>
                      <div class="navnode">
                              <div class="navnode_title">/on_learning/audio</div>
                              <div class="navnode"><a href="./../../on_learning/audio/wavenet_arch.html"> Behind WaveNet</a>
                              </div>
                      </div>
                      <div class="navnode">
                              <div class="navnode_title">/on_learning/image</div>
                              <div class="navnode"><a href="./../../on_learning/image/fast_lsgan.html">Fast LSGAN in Canton</a>
                              </div>
                              <div class="navnode"><a href="./../../on_learning/image/style_transfer.html">On Style Transfer 风格转移</a>
                              </div>
                      </div>
                      <div class="navnode">
                              <div class="navnode_title">/on_learning/motor_model</div>
                              <div class="navnode"><a href="./../../on_learning/motor_model/motor.html">Learn models of motors</a>
                              </div>
                      </div>
                      <div class="navnode">
                              <div class="navnode_title">/on_learning/npeg</div>
                              <div class="navnode"><a href="./../../on_learning/npeg/npeg.html">NPEG图像压缩</a>
                              </div>
                      </div>
                      <div class="navnode">
                              <div class="navnode_title">/on_learning/activations</div>
                              <div class="navnode"><a href="./../../on_learning/activations/index.html">Activation Functions</a>
                              </div>
                              <div class="navnode"><a href="./../../on_learning/activations/relu.html">Rectified Linear Unit 整流线性单元</a>
                              </div>
                      </div>
                      <div class="navnode">
                              <div class="navnode_title">/on_learning/rl</div>
                              <div class="navnode"><a href="./../../on_learning/rl/bipedal.html">BipedalWalker-v2</a>
                              </div>
                              <div class="navnode"><a href="./../../on_learning/rl/ddpg.html">DDPG Method</a>
                              </div>
                              <div class="navnode"><a href="./../../on_learning/rl/rl.html">RL is progressing rapidly</a>
                              </div>
                              <div class="navnode"><a href="./../../on_learning/rl/vrep.html">V-REP + Gym = RL</a>
                              </div>
                      </div>
                      <div class="navnode">
                              <div class="navnode_title">/on_learning/gru</div>
                              <div class="navnode"><a href="./../../on_learning/gru/gru.html">GRU and Convolutional GRU</a>
                              </div>
                      </div>
              </div>
              <div class="navnode">
                      <div class="navnode_title">/on_life</div>
                      <div class="navnode"><a href="./../../on_life/beijing.html">北京收获</a>
                      </div>
                      <div class="navnode"><a href="./../../on_life/electrical.html">Power System Analysis</a>
                      </div>
                      <div class="navnode"><a href="./../../on_life/lang.html"> 编程语言的选择</a>
                      </div>
                      <div class="navnode"><a href="./../../on_life/nocode.html"> 不写码 No Code</a>
                      </div>
                      <div class="navnode"><a href="./../../on_life/numjs.html">NumJs</a>
                      </div>
                      <div class="navnode"><a href="./../../on_life/reprod.html"> 确定性</a>
                      </div>
              </div>
      </div>
    </div>
    <div class="markdown_content"><h1 data-sourcepos="3:1-3:45">NPEG图像压缩 - Neural Network Image Compression</h1>
<blockquote data-sourcepos="5:1-5:131">
<p data-sourcepos="5:3-5:131">This page is written in Chinese. English readers might prefer to go directly to the repository: <a href="https://github.com/ctmakro/npeg">https://github.com/ctmakro/npeg</a></p>
</blockquote>
<blockquote data-sourcepos="7:1-7:20">
<p data-sourcepos="7:3-7:20">阅读本文需要基本的卷积神经网络知识。</p>
</blockquote>
<p data-sourcepos="9:1-9:59">对二进制串进行编码，空间最优的方法是霍夫曼法。不同二进制串的熵不同，使用霍夫曼法进行编码后的长度也不同，即压缩比不同。</p>
<p data-sourcepos="11:1-11:9">下面是两串二进制：</p>
<p data-sourcepos="13:1-13:41">100001001000000000 - 10010110101101010001</p>
<p data-sourcepos="15:1-15:31">对霍夫曼法而言，第一串比第二串要更容易压缩，压缩后的长度更短。</p>
<p data-sourcepos="17:1-17:16">对媒体数据进行有损压缩，分两步：</p>
<ol data-sourcepos="19:1-21:0">
<li data-sourcepos="19:1-19:35">将媒体数据通过一定方法，转换成0或者1比较多的某种二进制表示形式</li>
<li data-sourcepos="20:1-21:0">对结果进行霍夫曼编码，实现压缩。</li>
</ol>
<p data-sourcepos="22:1-22:10">JPEG是这么做的：</p>
<ol data-sourcepos="24:1-29:0" start="0">
<li data-sourcepos="24:1-24:16">把图像分割成若干8x8小块</li>
<li data-sourcepos="25:1-25:24">把8x8的二维图像转换成64x1的一维图像</li>
<li data-sourcepos="26:1-26:28">对64x1图像作DFT，得到不同频率下的幅度和相位</li>
<li data-sourcepos="27:1-27:52">剔除DFT结果中幅度较小的项（假设人眼对这些项不敏感），使得结果中0变多，能够被霍夫曼法压缩得更小</li>
<li data-sourcepos="28:1-29:0">对结果进行霍夫曼编码，实现压缩。</li>
</ol>
<p data-sourcepos="30:1-30:82">JPEG这个方法有很多缺点。DFT剔除项之后，边缘处像素的值会发生变化，造成图像的不连续。经JPEG压缩的图像，最显著的特点就是图像中能看到大量8x8的马赛克方块。</p>
<p data-sourcepos="32:1-32:67">能不能别把图像切成一块一块分别转换成二进制串，而是连续地将整张图像转换成一张大的bitmap呢？嗯，可以用卷积神经网络(CNN)试试。</p>
<p data-sourcepos="34:1-34:71">要把图像转换成二进制串再转换回来，需要两个CNN，一个负责编码（图像-&gt;0-1 bitmap），一个负责解码（0-1 bitmap-&gt;图像）。</p>
<p data-sourcepos="36:1-36:26">训练架构（绿色箭头表示以降低误差为目标，更新参数）：</p>
<img class="graph" src="npeg_graph_0.svg" title="graph 0" />
<p data-sourcepos="40:1-40:75">其中sigmoid函数的作用是把encoder的输出限制到0和1之间。为了让网络多输出0，少输出1（以便压缩），我在生成的二进制码上添加了一个惩罚项：</p>
<pre><code data-sourcepos="42:1-44:71" class="language-python">loss = tf.reduce_mean((y-x)**2) + tf.reduce_mean(binary_code**2) * 0.01
</code></pre>
<p data-sourcepos="46:1-46:9">这样架构就变成了：</p>
<img class="graph" src="npeg_graph_1.svg" title="graph 1" />
<p data-sourcepos="50:1-50:14">训练开始之后，情况是这样的：</p>
<p data-sourcepos="52:1-52:22"><img src="npeg_lownoise.jpg" alt="" /></p>
<p data-sourcepos="54:1-54:7">左边从上到下：</p>
<ul data-sourcepos="56:1-59:0">
<li data-sourcepos="56:1-56:12">输入图像（共3通道）</li>
<li data-sourcepos="57:1-57:17">从sigmoid输出解码的图像</li>
<li data-sourcepos="58:1-59:0">将sigmoid输出二值化，然后解码的图像</li>
</ul>
<p data-sourcepos="60:1-60:7">右边从上到下：</p>
<ul data-sourcepos="62:1-64:0">
<li data-sourcepos="62:1-62:30">sigmoid输出 （由左边第一张图生成，共128通道）</li>
<li data-sourcepos="63:1-64:0">sigmoid输出，二值化之后</li>
</ul>
<p data-sourcepos="65:1-65:135">仔细看可以看到，sigmoid输出并不是用0和1，而是在用深浅不同的灰色表示信息，而decoder也是从这些深浅不同的灰色中还原图像的。如果我们把sigmoid输出二值化，这些信息就完全丢失了。那么，要怎样才能逼神经网络用0和1，而不是0和1之间的其他数值来表示信息呢？</p>
<p data-sourcepos="67:1-67:8">答案是增加噪声！</p>
<p data-sourcepos="69:1-69:74">如果我们在sigmoid函数之前添加高斯噪声，那么encoder和decoder就会开始发现，用灰色不可靠，只有用0和1编码的信息才能抵御噪声干扰。</p>
<p data-sourcepos="71:1-71:17">增加高斯噪声之后，架构变成了这样：</p>
<img class="graph" src="npeg_graph_2.svg" title="graph 2" />
<p data-sourcepos="75:1-75:19">将噪声的标准差调到15，训练效果如下：</p>
<p data-sourcepos="77:1-77:23"><img src="npeg_highnoise.jpg" alt="" /></p>
<p data-sourcepos="79:1-79:50">可以看到，网络已经学会用二进制dither来编码图像内容，对sigmoid输出做不做二值化区别不大。</p>
<p data-sourcepos="81:1-81:53">运行本文实验的代码在我的github上：<a href="https://github.com/ctmakro/npeg">https://github.com/ctmakro/npeg</a></p>
</div>
    <div class="meta_string">
      <p>file: npeg.md</p>
      <p>last modified: 2017-03-26 16:30</p>
    </div>
    <script>
      //if(window.HighlightEverything){window.HighlightEverything()}
      
    </script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/atom-one-light.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
    <script>
      hljs.initHighlightingOnLoad();
      
    </script>
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
  </body>
</html>